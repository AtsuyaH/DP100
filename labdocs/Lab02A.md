# Lab 2A: Azure ML Designerを使用してトレーニングパイプラインを作成する

*Designer*インターフェイスは、機械学習モデルを作成するためのワークフロー、またはデータの取り込み、変換、モデルトレーニングモジュールの*パイプライン*を定義できるドラッグアンドドロップ環境を提供します。その後、このパイプラインを、クライアントアプリケーションが*推論*（新しいデータから予測を生成する）に使用できるWebサービスとして公開できます。

> **Note**: この記事の執筆時点では、Azure Machine Learning Designerは*プレビュー*状態です。予期しないエラーが発生する場合があります。

## 始める前に

このラボを開始する前に、[ラボ1A](Lab01A.md)および[ラボ1B](Lab01B.md)を完了していることを確認してください。これらには、このラボで使用するAzure Machine Learningワークスペースおよびその他のリソースを作成するタスクが含まれています。

## Task 1: デザイナーパイプラインを作成してデータを探索する

Designerを開始するには、最初にパイプラインを作成し、使用するデータセットを追加する必要があります。

1. ワークスペースの[Azure Machine Learning studio](https://ml.azure.com)で、**Designer**ページを表示し、新しいパイプラインを作成します。
2. [**設定**]ペインで、デフォルトのパイプライン名（**Pipeline-Created-on-date**）を**Visual Diabetes Training**（**設定**ペインが表示されていない場合、上部のパイプライン名の横にある**⚙**アイコンをクリックします）。
3. パイプラインを実行する計算ターゲットを指定する必要があることに注意してください。 [**設定**]ペインで[**コンピューティングターゲットの選択**]をクリックし、前のラボで作成した**aml-cluster*コンピューティングターゲットを選択します。
4. デザイナーの左側で、**データセット**セクションを展開し、前の演習で作成した**diabetes dataset**データセットをキャンバスにドラッグします。
5. キャンバスで**diabetes dataset**モジュールを選択し、その設定を表示します。 [**output**]タブで、[**visualize**]アイコン（縦棒グラフに似ています）をクリックします。
6. データのスキーマを確認し、さまざまな列の分布をヒストグラムとして表示できることに注意してください。次に、視覚エフェクトを閉じます。

## Task 2: 変換を追加

モデルをトレーニングする前に、通常、いくつかの前処理変換をデータに適用する必要があります。

1. 左側のペインで、**Data Transformation**セクションを展開します。このセクションには、モデルのトレーニングの前にデータを変換して前処理するために使用できる幅広いモジュールが含まれています。 **Normalize Data**モジュールをキャンバスの**diabetes dataset**モジュールの下にドラッグします。次に、**diabetes dataset**モジュールの出力を**Normalize Data**モジュールの入力に接続します。
2. **Normalize Data**モジュールを選択し、その設定を表示します。変換方法と変換する列を指定する必要があることに注意してください。次に、変換を**ZScore**のままにして、以下を含むように列を編集します
column names:
    * PlasmaGlucose
    * DiastolicBloodPressure
    * TricepsThickness
    * SerumInsulin
    * BMI
    * DiabetesPedigree

    > **Note**: 数値列を正規化して同じスケールにし、値が大きい列がモデルトレーニングを支配しないようにします。通常、このような前処理変換の全体を適用してトレーニング用のデータを準備しますが、この演習では簡単に説明します。

3. Now we're ready to split the data into separate datasets for training and validation. In the pane on the left, in the **Data Transformations** section, drag a **Split Data** module onto the canvas under the **Normalize Data** module. Then connect the *Transformed Dataset* (left) output of the **Normalize Data** module to the input of the **Split Data** module.
3. これで、トレーニングと検証のためにデータを個別のデータセットに分割する準備ができました。左側のペインの**Data Transformations**セクションで、**Split Data**モジュールを**Normalize Data**モジュールの下のキャンバスにドラッグします。次に、**Normalize Data**モジュールの* Transformed Dataset*（左）出力を**Split Data**モジュールの入力に接続します。

4. **Split Data**モジュールを選択し、次のように設定します:
    * **Splitting mode** Split Rows
    * **Fraction of rows in the first output dataset**: 0.7
    * **Random seed**: 123
    * **Stratified split**: False

## Task 3: モデルトレーニングモジュールを追加する

データを準備し、トレーニングデータセットと検証データセットに分割したら、パイプラインを構成してモデルをトレーニングおよび評価できます。

1. Expand the **Model Training** section in the pane on the left, and drag a **Train Model** module to the canvas, under the **Split Data** module. Then connect the *Result dataset1* (left) output of the **Split Data** module to the *Dataset* (right) input of the **Train Model** module.
1. 左側のペインの**Model Training**セクションを展開し、**Train Model**モジュールをキャンバスの**スプリットデータ**モジュールの下にドラッグします。次に、** Split Data **モジュールの* Result dataset1 *（左）出力を** Train Model **モジュールの* Dataset *（右）入力に接続します。


2. The model we're training will predict the **Diabetic** value, so select the **Train Model** module and modify its settings to set the **Label column** to  **Diabetic** (matching the case and spelling exactly!)
3. The **Diabetic** label the model will predict is a binary column (1 for patients who have diabetes, 0 for patients who don't), so we need to train the model using a *classification* algorithm. Expand the **Machine Learning Algorithms** section, and under **Classification**, drag a **Two-Class Logistic Regression** module to the canvas, to the left of the **Split Data** module and above the **Train Model** module. Then connect its output to the **Untrained model** (left) input of the **Train Model** module.
4. To test the trained model, we need to use it to score the validation dataset we held back when we split the original data. Expand the **Model Scoring & Evaluation** section and drag a **Score Model** module to the canvas, below the **Train Model** module. Then connect the output of the **Train Model** module to the **Trained model** (left) inout of the **Score Model** module; and drag the **Results dataset2** (right) output of the **Split Data** module to the **Dataset** (right) input of the **Score Model** module.
5. To evaluate how well the model performs, we need to look at some metrics generated by scoring the validation dataset. From the **Model Scoring & Evaluation** section, drag an **Evaluate Model** module to the canvas, under the **Score Model** module, and connect the output of the **Score Model** module to the **Score dataset** (left) input of the **Evaluate Model** module.

## Task 4:  Run the Training Pipeline

With the data flow steps defined, you're now ready to run the training pipeline and train the model.

1. Verify that your pipeline looks similar to the following (note that the image includes comments in each module to document what they're doing - it's not a bad idea to do this when you're using the Designer for a real project!):

    ![Visual Training Pipeline](images/visual-training.jpg)

2. At the top right, click **Run**. Then when prompted, create a new *experiment* named **visual-training**, and run it.  This will initialize the compute target and then run the pipeline, which may take 10 minutes or longer. You  can see the status of the pipeline run above the top right of the design canvas.

    **Tip**: While it's running, you can view the pipeline and experiment that have been created in the **Pipelines** and **Experiments** pages. Switch back to the **Visual Diabetes Training** pipeline on the **Designer** page when you're done.

3. After the **Normalize Data** module has finished (indicated by a &#x2705; icon), select it, and in the **Settings** pane, on the **Outputs** tab, in the **Transformed dataset** section, click the **Visualize** icon, and note that you can view statistics and distribution visualizations for the transformed columns.
4. Close the **Normalize Data** visualizations and wait for the rest of the modules to complete. Then visualize the **Evaluate Model** module to see the performance metrics for the model.

    **Note**: The performance of this model isn't all that great, partly because we performed only minimal feature engineering and pre-processing. You could try some different classification algorithms and compare the results (you can connect the outputs of the **Split Data** module to multiple **Train Model** and **Score Model** modules, and you can connect a second scored model to the **Evaluate Model** module to see a side-by-side comparison). The point of the exercise is simply to introduce you to the Designer interface, not to train a perfect model!
